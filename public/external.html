<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>MUSE External Shop</title>

<style>
:root{
  --bg0:#070b14;
  --bg1:#0b1220;

  --card: rgba(255,255,255,.08);
  --card-border: rgba(255,255,255,.16);

  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.72);

  --field: rgba(255,255,255,.10);
  --field-border: rgba(255,255,255,.16);

  --focus: rgba(56,189,248,.60);
  --ring: 0 0 0 3px var(--focus);

  --shadow: 0 22px 70px rgba(0,0,0,.48);
  --radius: 20px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  min-height:100svh;
  padding:clamp(18px,3vw,28px);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 600px at 18% 10%, rgba(56,189,248,.22), transparent 60%),
    radial-gradient(900px 500px at 85% 18%, rgba(167,139,250,.18), transparent 55%),
    radial-gradient(900px 600px at 42% 92%, rgba(34,197,94,.12), transparent 55%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}

.shell{
  width:min(900px,100%);
  margin:0 auto;
  display:grid;
  gap:18px;
}

.card{
  border-radius:var(--radius);
  background:var(--card);
  border:1px solid var(--card-border);
  box-shadow:var(--shadow);
  padding:clamp(20px,3vw,32px);
  backdrop-filter:blur(12px);
}

header{
  text-align:center;
}

header img{
  width:60px;
  height:60px;
  object-fit:contain;
  border-radius:16px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  padding:6px;
  margin-bottom:10px;
}

h1{
  margin:0;
  font-size:clamp(20px,2.5vw,28px);
  letter-spacing:-0.02em;
}

.sub{
  margin-top:6px;
  color:var(--muted);
  font-size:14px;
}

label{
  display:block;
  font-size:13px;
  color:var(--muted);
  margin-bottom:6px;
}

select,
input[type="text"],
input[type="email"],
input[type="number"]{
  width:100%;
  padding:14px;
  border-radius:14px;
  background:var(--field);
  border:1px solid var(--field-border);
  color:var(--text);
  font-size:15px;
  outline:none;
}

select:focus-visible,
input:focus-visible{
  box-shadow:var(--ring);
  border-color:rgba(56,189,248,.55);
}

/* ===== DROPDOWN FIX ===== */
select{
  color-scheme: dark;
}
select option,
select optgroup{
  background-color:#0b1220;
  color:rgba(255,255,255,.92);
}
select option:checked{
  background-color:rgba(56,189,248,.28);
  color:rgba(255,255,255,.92);
}
/* ========================= */

.section-title{
  margin:20px 0 10px;
  font-size:14px;
}

.product,
.cart-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  margin-bottom:10px;
}

.qty-control{
  display:flex;
  gap:6px;
  align-items:center;
}

.qty-control button{
  padding:8px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.16);
  color:var(--text);
  font-size:18px;
  cursor:pointer;
}

.qty-control input{
  width:60px;
  text-align:center;
  background:rgba(255,255,255,.08);
}

.cart{
  margin-top:20px;
  padding-top:14px;
  border-top:1px solid rgba(255,255,255,.12);
}

.total{
  font-size:16px;
  margin-top:8px;
}

button#checkout{
  width:100%;
  margin-top:14px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.14);
  color:var(--text);
  font-size:15px;
  cursor:pointer;
}

button#checkout:disabled{
  opacity:.5;
  cursor:not-allowed;
}

#toast-container{
  position:fixed;
  bottom:1rem;
  right:1rem;
  display:flex;
  flex-direction:column;
  gap:0.5rem;
  z-index:9999;
}

.toast{
  background:rgba(20,20,24,.92);
  padding:0.75em 1em;
  border-radius:14px;
  opacity:0;
  transform:translateY(16px);
  transition:opacity .3s ease, transform .3s ease;
  font-size:0.9rem;
}

.toast.show{
  opacity:1;
  transform:translateY(0);
}
</style>
</head>

<body>
<main class="shell">

<section class="card">
<header>
<img src="logo.png" alt="MUSE Logo" />
<h1>MUSE External Shop</h1>
<div class="sub">Prezzi sempre mostrati IVA esclusa.</div>
</header>

<div class="section-title">Dettagli Cliente</div>
<label for="region">Regione</label>
<select id="region" required>
<option value="">Seleziona Regione…</option>
<option value="Dolomites">Dolomites</option>
<option value="South Tyrol">South Tyrol</option>
<option value="Garda">Garda</option>
</select>

<div id="products"></div>

<div class="cart">
<h2>Carrello</h2>
<div id="cart-items"></div>
<div class="total">Totale: €<span id="total">0.00</span></div>
<div class="sub">Prezzi sempre mostrati IVA esclusa.</div>

<input id="name" type="text" placeholder="Il tuo nome" required />
<input id="email" type="email" placeholder="La tua email" required />
<button id="checkout">Invia Ordine</button>
</div>
</section>

<div id="toast-container"></div>

<script>
 <script>
      // 1) Define per-region catalogs
      const PRODUCTS_BY_REGION = {
        Dolomites: [
          { id: 1, title: "ASCIUGAMANO BAGNO 100x150", description: "6 per Pacco", price: 11.77 },
          { id: 2, title: "LENZUOLO C.ANG 2P DELUXE 200x210", description: "5 per Pacco", price: 21.47 },
          { id: 3, title: "LENZUOLO C.ANG 1P DELUXE 100x210", description: "5 per Pacco", price: 16.45 },
          { id: 4, title: "LENZUOLO 2P 240x300", description: "10 per Pacco", price: 28.17 },
          { id: 5, title: "LENZUOLO 1P 160x300", description: "10 per Pacco", price: 19.04 },
          { id: 6, title: "FEDERA GRANDE 60x80", description: "25 per Pacco", price: 29.44 },
          { id: 7, title: "FEDERA PICCOLA 50x80", description: "25 per Pacco", price: 26.99 },
          { id: 8, title: "COPRIPIUMINO 1P 135x200", description: "10 per Pacco", price: 35.78 },
          { id: 9, title: "TOVAGLIA 150x150", description: "10 per Pacco", price: 29.75 },
          { id: 10, title: "STROFINACCI PER BICCHIERI 50x70", description: "25 per Pacco", price: 19.99 },
          { id: 11, title: "SCENDIBAGNO 50x90", description: "12 per Pacco", price: 18.18 },
          { id: 12, title: "ASCIUGAMANO BIDET 40x60", description: "20 per Pacco", price: 19.36 },
          { id: 13, title: "ASCIUGAMANO VISO 50x100", description: "12 per Pacco", price: 11.51 },
        ],
        "South Tyrol": [
          { id: 1, title: "ASCIUGAMANO BAGNO 100x150", description: "6 per Pacco", price: 11.77 },
          { id: 2, title: "LENZUOLO 2P 240x300", description: "10 per Pacco", price: 28.17 },
          { id: 3, title: "LENZUOLO 1P 160x300", description: "10 per Pacco", price: 19.04 },
          { id: 4, title: "FEDERA GRANDE 60x80", description: "25 per Pacco", price: 29.44 },
          { id: 5, title: "FEDERA PICCOLA 50x80", description: "25 per Pacco", price: 26.99 },
          { id: 6, title: "COPRIPIUMINO 1P 135x200", description: "10 per Pacco", price: 35.78 },
          { id: 7, title: "TOVAGLIA 150x150", description: "10 per Pacco", price: 29.75 },
          { id: 8, title: "STROFINACCI PER BICCHIERI 50x70", description: "25 per Pacco", price: 19.99 },
          { id: 9, title: "SCENDIBAGNO 50x90", description: "12 per Pacco", price: 18.18 },
          { id: 10, title: "ASCIUGAMANO BIDET 40x60", description: "20 per Pacco", price: 19.36 },
          { id: 11, title: "ASCIUGAMANO VISO 50x100", description: "12 per Pacco", price: 11.51 },
        ],
        Garda: [
          { id: 1, title: "ASCIUGAMANO BAGNO 100x150", description: "6 per Pacco", price: 11.77 },
          { id: 2, title: "LENZUOLO 2P 240x300", description: "10 per Pacco", price: 28.17 },
          { id: 3, title: "LENZUOLO 1P 160x300", description: "10 per Pacco", price: 19.04 },
          { id: 4, title: "FEDERA GRANDE 60x80", description: "25 per Pacco", price: 29.44 },
          { id: 5, title: "FEDERA PICCOLA 50x80", description: "25 per Pacco", price: 26.99 },
          { id: 6, title: "COPRIPIUMINO 1P 135x200", description: "10 per Pacco", price: 35.78 },
          { id: 7, title: "TOVAGLIA 150x150", description: "10 per Pacco", price: 29.75 },
          { id: 8, title: "STROFINACCI PER BICCHIERI 50x70", description: "25 per Pacco", price: 19.99 },
          { id: 9, title: "SCENDIBAGNO 50x90", description: "12 per Pacco", price: 18.18 },
          { id: 10, title: "ASCIUGAMANO BIDET 40x60", description: "20 per Pacco", price: 19.36 },
          { id: 11, title: "ASCIUGAMANO VISO 50x100", description: "12 per Pacco", price: 11.51 },
        ]
      };

      let currentProducts = [];
      let cart = [];

      // 2) Render products with spinner controls
      function renderProducts() {
        const root = document.getElementById("products");
        root.innerHTML = "";
        currentProducts.forEach(p => {
          const line = cart.find(x => x.id === p.id);
          const qty  = line ? line.qty : 0;
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML = `
            <div>
              <div><strong>${p.title} — €${p.price.toFixed(2)}</strong></div>
              <div><small>${p.description}</small></div>
            </div>
            <div class="qty-control">
              <button onclick="removeFromCart(${p.id})">−</button>
              <input 
                type="number"
                min="0"
                value="${qty}"
                onchange="updateQty(${p.id}, this.value)"
              />
              <button onclick="addToCart(${p.id})">+</button>
            </div>
          `;
          root.append(div);
        });
      }

      // 3) Cart operations
      function addToCart(id) {
        const prod = currentProducts.find(x => x.id === id);
        let line  = cart.find(x => x.id === id);
        if (!line) { line = {...prod, qty:0}; cart.push(line); }
        line.qty++;
        renderCart();
        renderProducts();
      }
      function removeFromCart(id) {
        cart = cart.map(x => x.id===id ? {...x,qty:x.qty-1} : x).filter(x => x.qty>0);
        renderCart();
        renderProducts();
      }
      function updateQty(id, value) {
        const q = parseInt(value,10) || 0;
        cart = cart.map(x => x.id===id ? {...x,qty:q} : x).filter(x => x.qty>0);
        renderCart();
        renderProducts();
      }

      // 4) Render cart
      function renderCart() {
        const root = document.getElementById("cart-items");
        root.innerHTML = "";
        let total = 0;
        cart.forEach(item => {
          total += item.qty * item.price;
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <span>${item.title}</span>
            <div class="qty-control">
              <button onclick="removeFromCart(${item.id})">−</button>
              <input 
                type="number"
                value="${item.qty}"
                min="0"
                onchange="updateQty(${item.id}, this.value)"
              />
              <button onclick="addToCart(${item.id})">+</button>
            </div>
          `;
          root.append(div);
        });
        document.getElementById("total").textContent = total.toFixed(2);
      }

      // 5) Toast helper
      function showToast(msg,duration=3000){
        const c = document.getElementById("toast-container");
        const t = document.createElement("div");
        t.className = "toast";
        t.textContent = msg;
        c.append(t);
        requestAnimationFrame(()=>t.classList.add("show"));
        setTimeout(()=>{
          t.classList.remove("show");
          t.addEventListener("transitionend",()=>t.remove(),{once:true});
        },duration);
      }

      // 6) Region change
      document.getElementById("region").onchange = function(){
        cart = [];
        renderCart();
        currentProducts = PRODUCTS_BY_REGION[this.value] || [];
        renderProducts();
      };

      // 7) Prevent double‐submit & checkout
      let isSubmitting = false;
      document.getElementById("checkout").onclick = async ()=> {
        if (isSubmitting) return;
        isSubmitting = true;
        const btn = document.getElementById("checkout");
        btn.disabled = true;
        btn.textContent = "Invio in corso…";

        const region = document.getElementById("region").value;
        const name   = document.getElementById("name").value.trim();
        const email  = document.getElementById("email").value.trim();
        if (!region || !name || !email || cart.length === 0) {
          showToast("Seleziona regione, nome, email e aggiungi almeno un prodotto.");
          btn.disabled = false;
          btn.textContent = "Invia Ordine";
          isSubmitting = false;
          return;
        }

        try {
          const res = await fetch("/checkout", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
              region, name, email, cartJson: JSON.stringify(cart)
            })
          });
          const { success } = await res.json();
          if (success) showToast("Ordine inviato! Controlla la tua email.");
          else showToast("Errore—riprovare.");
        } catch {
          showToast("Errore di rete—riprovare.");
        }

        btn.disabled = false;
        btn.textContent = "Invia Ordine";
        isSubmitting = false;
      };

      // initial render
      renderCart();
    </script>
  </body>
</html>
